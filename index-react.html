<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AMP React in React by React</title>
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

  <script src="https://unpkg.com/preact@10.0.0-rc.3/dist/preact.umd.js"></script>
  <script src="https://unpkg.com/preact@10.0.0-rc.3/hooks/dist/hooks.umd.js"></script>
  <script src="https://unpkg.com/preact@10.0.0-rc.3/compat/dist/compat.umd.js"></script>
  <script>
    window.React = Object.assign({}, preact, preactHooks, preactCompat);
  </script>
  <script src="https://unpkg.com/react-router-dom/umd/react-router-dom.js"></script>
  <script src="https://unpkg.com/babel-standalone/babel.min.js"></script>
  <script type="module">
    import {AmpAccordion} from './src/amp-react-accordion.js';
    import {AmpCarousel} from './src/amp-react-carousel.js';
    import {AmpFitText} from './src/amp-react-fit-text.js';
    import {AmpImg} from './src/amp-react-img.js';
    import {AmpLayout} from './src/amp-react-layout.js';
    import {AmpLightbox} from './src/amp-react-lightbox.js';
    import {AmpSelector} from './src/amp-react-selector.js';
    import {AmpSize} from './src/amp-react-size.js';
    import {AmpYoutube} from './src/amp-react-youtube.js';
    Object.assign(window, {
      AmpAccordion,
      AmpCarousel,
      AmpImg,
      AmpFitText,
      AmpLayout,
      AmpLightbox,
      AmpSelector,
      AmpSize,
      AmpYoutube,
    });
  </script>
  <style>
    li[selected] {
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="app"></div>

<script type="text/babel">
/**
 * @jsx preact.createElement
 * @jsxFrag preact.Fragment
 */

class App extends preact.Component {
  state = {
    slides: [0, 1, 2, 3, 4, 5],
    lightbox1Open: false,
    selector1Value: '1',
    accordion1Expanded: '1',
  };

  constructor(props) {
    super(props);
    this.backButtonService = new BackButtonServiceFake();
    this.buttonRef = preact.createRef();
  }

  render() {
    const lightbox1BlockedMessage =
      'This lightbox has unsaved changes. Are you sure you want to close it?';
    return (
      <main>

        <div style={{margin: '8px 0', width: '100%', height: '100px', border: '1px dotted lightgreen', position: 'relative'}}>
          {
            !this.state.removed &&
          (<AmpSize tagName={this.state.tagName || 'div'} other={this.state.other} style={{position: 'absolute', width: '100%', height: '100%'}}></AmpSize>
          )
          }
        </div>

        <button onClick={() => this.setState({other: 'x'})}>ping</button>
        <button onClick={() => this.setState({tagName: 'article'})}>change</button>
        <button onClick={() => this.setState({removed: true})}>remove</button>
      </main>
    )
  }
}


// TODO: redo this service via Router.history object.
class BackButtonServiceFake {
  /** @return BackButtonMarker */
  push() {
    return new BackButtonMarkerFake();
  }
}

class BackButtonMarkerFake {
  constructor() {
    this.closed = false;
    /** @type {?function()} */
    this.onPop = null;

    /** @private {boolean} */
    this.popped_ = false;
    this.popHandler_ = () => {
      this.popped_ = true;
      this.pop();
    };
    window.addEventListener('popstate', this.popHandler_);
    history.pushState({index: 1}, '');
  }

  pop() {
    if (this.closed) {
      return;
    }
    this.closed = true;
    if (this.onPop) {
      this.onPop();
      this.onPop = null;
    }
    if (!this.popped_) {
      this.popped_ = true;
      history.go(-1);
    }
    if (this.popHandler_) {
      window.removeEventListener('popstate', this.popHandler_);
      this.popHandler_ = null;
    }
  }
}


preact.render(<App/>, document.getElementById('app'))
</script>
</body>
</html>
